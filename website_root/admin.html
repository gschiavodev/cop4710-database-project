<?php
    
    session_start();

    // Check if user is logged in
    if (isset($_SESSION['username'])) 
    {

        // Database connection information
        $servername = "mysql";
        $username = "webserver";
        $password = "X7g9#4vZ1$2cQ5";
        $database = "college_events";

        // Create connection
        $conn = mysqli_connect($servername, $username, $password, $database);

        // Check connection
        if (!$conn) 
            die("Connection failed: " . mysqli_connect_error());

        // Prepare a SELECT statement to get the user with the provided username
        $statement = $conn->prepare("SELECT * FROM admin WHERE id = ?");
        $statement->bind_param("i", $_SESSION['user_id']);
        $statement->execute();

        // Get the result of the SELECT query
        $result = $statement->get_result();

        // Check if the user exists and set as admin
        $_SESSION['is_admin'] = $result->num_rows != 0 ? true : false;

        // If the user is not an admin, check if the user is a super admin
        if (!$_SESSION['is_admin']) 
        {

            // Prepare a SELECT statement to get the user with the provided username
            $statement = $conn->prepare("SELECT * FROM super_admin WHERE id = ?");
            $statement->bind_param("i", $_SESSION['user_id']);
            $statement->execute();

            // Get the result of the SELECT query
            $result = $statement->get_result();

            // Check if the user exists and set as super admin
            $_SESSION['is_super_admin'] = $result->num_rows != 0 ? true : false;

        }

        // If the user is not an admin, redirect to index.html
        if (!$_SESSION['is_admin'] && !$_SESSION['is_super_admin']) 
        {

            header('Location: index.html');
            exit();

        }

    }
    else
    {

        // User is not logged in, redirect to login.html
        header('Location: login.html');
        exit();

    }

?>

<!DOCTYPE html>

<html>

    <head>
        <title>College Event Website</title>
        <link rel="stylesheet" type="text/css" href="css/common_styles.css">
        <link rel="stylesheet" type="text/css" href="css/form_styles.css">
    </head>

    <body>
        
        <header>
            <nav>
                <ul>

                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html">Events</a></li>
                    <li><a href="index.html">RSOs</a></li>

                </ul>
                <ul>

                    <li><a href="admin.html">Admin</a></li>
                    <li><a href="index.html?logout=true">Logout</a></li>

                </ul>
            </nav>
        </header>

        <main>

            <div class="row">

                <section>
                    <?php if ($_SESSION['is_super_admin']): ?>
                        <h1>Super Admin Panel</h1>
                    <?php else: ?>
                        <h1>Admin Panel</h1>
                    <?php endif; ?>
                </section>
                
            </div>
            
            <?php if ($_SESSION['is_super_admin']): ?>
                <div class="row">

                    <section style="flex: 2">
                        <h2>Manage Admins</h2>
                        <p>Use this form to promote or demote a user to or from admin status.</p>
                    </section>
                    
                    <section>
                        <form method="POST" style="width: 100%">
                            <label for="username">Username:</label>
                            <input type="text" id="username" name="username" required>
                            <input type="submit" value="Promote">
                            <input type="submit" value="Demote">
                        </form>
                    </section>

                </div>

                <div class="row">

                    <section style="flex: 1">
                        <h2>Create University Profile</h2>
                        <p>Use this form to create a new university profile.</p>
                    </section>
                    
                    <section style="flex: 2">
                        <form method="POST" style="width: 100%">

                            <!-- University Name -->
                            <label for="university_name">University Name:</label>
                            <input type="text" id="university_name" name="university_name" required>

                            <!-- University Address Fields -->
                            <label for="address_line_01">Address Line 1:</label>
                            <input type="text" id="address_line_01" name="address" required>
                            <label for="address_line_02">Address Line 2:</label>
                            <input type="text" id="address_line_02" name="address">
                            <label for="city">City:</label>
                            <input type="text" id="city" name="city" required>
                            <label for="state">State:</label>
                            <input type="text" id="state" name="state" required>
                            <label for="zip">Area-code:</label>
                            <input type="text" id="zip" name="zip" required>

                            <!-- University Description -->
                            <label for="description">Description:</label>
                            <textarea id="description" name="description" required></textarea>

                            <!-- Number of Students -->
                            <label for="num_students">Number of Students:</label>
                            <input type="number" id="num_students" name="num_students" required>

                            <!-- Submit Button -->
                            <input type="submit" value="Create">
                        </form>
                    </section>
                </div>
            <?php endif; ?>
            
            <div class="row">

                <section>
                    <h2>Manage Registered Student Organizations</h2>
                    <p>Use this section to manage registered student organizations that you own.</p>
                </section>
            
            </div>

            <div class="row">
                
                <?php
                        
                    // Prepare a SELECT statement to get the RSOs that the user owns
                    $statement = $conn->prepare("SELECT * FROM rso WHERE admin_id = ?");
                    $statement->bind_param("i", $_SESSION['user_id']);
                    $statement->execute();

                    // Get the result of the SELECT query
                    $result = $statement->get_result();

                    // Check if the user owns any RSOs
                    if ($result->num_rows > 0) 
                    {

                        // Loop through each RSO
                        while ($row = $result->fetch_assoc()) 
                        {

                            // Display the RSO information
                            echo "<section>";
                            echo "<h3>" . $row['name'] . "</h3>";
                            echo "<p>" . $row['description'] . "</p>";
                            echo "<p>Members: " . $row['num_members'] . "</p>";
                            echo "<p>University: " . $row['university_id'] . "</p>";
                            echo "</section>";

                        }

                    }
                    else
                    {

                        // Display a message if the user does not own any RSOs
                        echo "<section style='flex: 1'>";
                        echo "<p>You do not own any RSOs.</p>";
                        echo "</section>";

                    }
                ?>
                
            </div>

        </main>

        <footer>
            <p>&copy; Gabriel Schiavo</p>
        </footer>
        
    </body>
</html>